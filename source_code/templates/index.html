<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meteorological Data WebApp</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='drdo_logo.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header text-center mt-3">
  <img src="{{ url_for('static', filename='drdo_logo.png') }}" alt="DRDO Logo">
  <h1>Meteorological Data WebApp</h1>
</div>

<div class="container mt-4">
  <form id="uploadForm" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label class="form-label">Select Dataset Type:</label>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="dataset_type" id="isro" value="ISRO" {% if dataset_type == 'ISRO' %}checked{% endif %}>
        <label class="form-check-label" for="isro">ISRO Dataset</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="dataset_type" id="komoline" value="Komoline" {% if dataset_type == 'Komoline' %}checked{% endif %}>
        <label class="form-check-label" for="komoline">Komoline Dataset</label>
      </div>
    </div>

    <div class="dropzone" id="dropzone">
      Drag & Drop CSV files here or click to select files
      <input type="file" id="fileInput" name="files" accept=".csv" multiple style="display:none;">
    </div>

    <div id="file-list" class="mt-2"></div>

    <div class="mb-3 mt-3">
      <label for="altitude" class="form-label">
        Enter Altitude Step (in meters):<br>
        <small class="text-muted">e.g., 200 will return data for 0, 200, 400, ...</small>
      </label>
      <input type="number" step="any" class="form-control" name="altitude">
    </div>

    <div class="d-flex gap-2 mb-4">
      <button type="submit" class="btn btn-success">Get Data</button>
      <button type="submit" class="btn btn-warning" name="auto_generate" value="1">Auto-generate</button>
      <a href="{{ url_for('clear_session') }}" class="btn btn-danger">Clear All & Reset</a>
    </div>
  </form>

  {% if error %}
    <div class="alert alert-danger mt-3">{{ error }}</div>
  {% endif %}

  {% if result %}
    <h3>Results</h3>
    <table class="table table-bordered table-striped mt-3 translucent-table">
      <thead class="table-success">
        <tr>
          <th>Dataset</th>
          <th>Input Altitude (m)</th>
          <th>Matched Altitude (m)</th>
          <th>Temperature (K)</th>
          <th>Pressure (hPa)</th>
          <th>Humidity (%)</th>
          <th>Wind Speed (m/s)</th>
          <th>Wind Direction (¬∞)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in result %}
          <tr>
            <td>{{ row['Dataset'] }}</td>
            <td>{{ row['Input_Altitude'] }}</td>
            <td>{{ row['Matched_Altitude_m'] }}</td>
            <td>{{ row['Temperature_K'] }}</td>
            <td>{{ row['Pressure_hPa'] }}</td>
            <td>{{ row['Humidity_percent'] }}</td>
            <td>{{ row['WindSpeed_mps'] }}</td>
            <td>{{ row['WindDirection_deg'] }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <a href="{{ url_for('download_csv') }}" class="btn btn-primary">üì• Download CSV</a>

    <div class="mt-5">
      <h4>üìà Graphical Visualization</h4>
      <div class="mt-4">
        <h5>Temperature (K)</h5>
        <canvas id="temperatureChart" height="100"></canvas>
      </div>
      <div class="mt-4">
        <h5>Pressure (hPa)</h5>
        <canvas id="pressureChart" height="100"></canvas>
      </div>
      <div class="mt-4">
        <h5>Humidity (%)</h5>
        <canvas id="humidityChart" height="100"></canvas>
      </div>
      <div class="mt-4">
        <h5>Wind Speed (m/s)</h5>
        <canvas id="windspeedChart" height="100"></canvas>
      </div>

      <!-- üå™Ô∏è Wind Rose Plot Integration -->
      <div class="mt-4">
        <h5>Wind Rose (Direction Frequency)</h5>
        {% if wind_rose_image %}
          <img src="data:image/png;base64,{{ wind_rose_image }}" class="img-fluid rounded shadow" alt="Wind Rose Chart">
        {% else %}
          <p class="text-muted">Wind Rose graph unavailable.</p>
        {% endif %}
      </div>
    </div>

    <script>
        const resultData = {{ result | tojson | safe }};
        const altitude = resultData.map(r => r.Input_Altitude);
        const temperature = resultData.map((r, i) => ({ x: r.Temperature_K, y: altitude[i] }));
        const pressure = resultData.map((r, i) => ({ x: r.Pressure_hPa, y: altitude[i] }));
        const humidity = resultData.map((r, i) => ({ x: r.Humidity_percent, y: altitude[i] }));
        const windspeed = resultData.map((r, i) => ({ x: r.WindSpeed_mps, y: altitude[i] }));

        const chartTemplate = (ctxId, label, data, color) => {
          new Chart(document.getElementById(ctxId), {
            type: "scatter",
            data: {
              datasets: [{
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: color,
                showLine: true,
                fill: false
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: {
                    display: true,
                    text: label
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: "Altitude (m)"
                  },
                  reverse: false,  // Ensures altitude increases from bottom to top
                  ticks: {
                    stepSize: 100  // optional
                  }
                }
              }
            }
          });
        };

        chartTemplate("temperatureChart", "Temperature (K)", temperature, "#dc3545");
        chartTemplate("pressureChart", "Pressure (hPa)", pressure, "#17a2b8");
        chartTemplate("humidityChart", "Humidity (%)", humidity, "#6f42c1");
        chartTemplate("windspeedChart", "Wind Speed (m/s)", windspeed, "#fd7e14");
      </script>

  {% endif %}
</div>

<footer class="text-center text-muted mt-5 mb-3">
  <div>¬© 2025 DRDO Meteorological WebApp | Version: v1.0</div>
  <div>üë®‚Äçüíª Developed by <strong>MET INTERNS</strong></div>
</footer>

<script>
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("fileInput");
  const fileList = document.getElementById("file-list");
  let filesArray = [];

  dropzone.addEventListener("click", () => fileInput.click());
  dropzone.addEventListener("dragover", e => {
    e.preventDefault();
    dropzone.classList.add("dragover");
  });
  dropzone.addEventListener("dragleave", () => {
    dropzone.classList.remove("dragover");
  });
  dropzone.addEventListener("drop", e => {
    e.preventDefault();
    dropzone.classList.remove("dragover");
    handleFiles(e.dataTransfer.files);
  });
  fileInput.addEventListener("change", () => {
    handleFiles(fileInput.files);
  });

  function handleFiles(files) {
    for (let file of files) {
      if (!filesArray.some(f => f.name === file.name)) {
        filesArray.push(file);
      }
    }
    updateFileInput();
    renderFileList();
  }

  function updateFileInput() {
    const dataTransfer = new DataTransfer();
    filesArray.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
  }

  function renderFileList() {
    fileList.innerHTML = "";
    filesArray.forEach((file, index) => {
      const div = document.createElement("div");
      div.className = "alert alert-secondary d-flex justify-content-between align-items-center";
      div.innerHTML = `
        ${file.name}
        <button type="button" class="btn btn-sm btn-danger">Remove</button>
      `;
      div.querySelector("button").addEventListener("click", () => {
        filesArray.splice(index, 1);
        updateFileInput();
        renderFileList();
      });
      fileList.appendChild(div);
    });
  }
</script>

</body>
</html>
